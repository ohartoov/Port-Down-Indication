/*
 * ibv_query_port_speed_example.c - Example application for ibv_query_port_speed()
 *
 * This example demonstrates how to:
 *   1. Query the effective bandwidth of an RDMA port using ibv_query_port_speed()
 *   2. Monitor for IBV_EVENT_DEVICE_SPEED_CHANGE async events
 *   3. Re-query port speed when a speed change event is received
 *
 * Compile:
 *   gcc -o ibv_query_port_speed_example ibv_query_port_speed_example.c -libverbs
 *
 * Usage:
 *   ./ibv_query_port_speed_example <device_name> <port_number>
 *
 * Example:
 *   ./ibv_query_port_speed_example mlx5_0 1
 *
 * Press Ctrl+C to exit the event monitoring loop.
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <errno.h>
#include <poll.h>
#include <infiniband/verbs.h>

static void query_port_speed(struct ibv_context *ctx, uint32_t port_num)
{
	uint64_t port_speed;
	int ret;

	ret = ibv_query_port_speed(ctx, port_num, &port_speed);
	if (ret) {
		printf("Port %u: Failed to query speed (errno=%d: %s)\n",
		       port_num, ret, strerror(ret));
		return;
	}

	/*
	 * port_speed is returned in units of 100 Mb/s.
	 * Multiply by 100 to get Mb/s, or divide by 10 to get Gb/s.
	 */
	printf("Port %u: %llu Mb/s (%.1f Gb/s)\n",
	       port_num,
	       (unsigned long long)port_speed * 100,
	       (double)port_speed / 10.0);
}

int main(int argc, char *argv[])
{
	struct ibv_device **dev_list;
	struct ibv_device *device = NULL;
	struct ibv_context *ctx = NULL;
	struct ibv_async_event event;
	struct pollfd pfd;
	uint32_t port_num;
	int num_devices;
	int ret = EXIT_SUCCESS;
	int i;

	if (argc != 3) {
		fprintf(stderr, "Usage: %s <device_name> <port_number>\n", argv[0]);
		fprintf(stderr, "Example: %s mlx5_0 1\n", argv[0]);
		return EXIT_FAILURE;
	}

	port_num = atoi(argv[2]);
	if (port_num == 0) {
		fprintf(stderr, "Error: Invalid port number (must be >= 1)\n");
		return EXIT_FAILURE;
	}

	/* Get list of available RDMA devices */
	dev_list = ibv_get_device_list(&num_devices);
	if (!dev_list) {
		fprintf(stderr, "Error: Failed to get device list: %s\n",
			strerror(errno));
		return EXIT_FAILURE;
	}

	if (num_devices == 0) {
		fprintf(stderr, "Error: No RDMA devices found\n");
		ret = EXIT_FAILURE;
		goto free_dev_list;
	}

	/* Find the requested device */
	for (i = 0; i < num_devices; i++) {
		if (strcmp(ibv_get_device_name(dev_list[i]), argv[1]) == 0) {
			device = dev_list[i];
			break;
		}
	}

	if (!device) {
		fprintf(stderr, "Error: Device '%s' not found\n", argv[1]);
		fprintf(stderr, "Available devices:\n");
		for (i = 0; i < num_devices; i++)
			fprintf(stderr, "  %s\n", ibv_get_device_name(dev_list[i]));
		ret = EXIT_FAILURE;
		goto free_dev_list;
	}

	/* Open the device */
	ctx = ibv_open_device(device);
	if (!ctx) {
		fprintf(stderr, "Error: Failed to open device: %s\n",
			strerror(errno));
		ret = EXIT_FAILURE;
		goto free_dev_list;
	}

	printf("Device: %s, Port: %u\n\n", ibv_get_device_name(device), port_num);

	/* Query initial port speed */
	printf("Initial speed:\n");
	query_port_speed(ctx, port_num);
	printf("\n");

	/* Set up polling on the async event file descriptor */
	pfd.fd = ctx->async_fd;
	pfd.events = POLLIN;

	printf("Monitoring for speed change events (Ctrl+C to exit)...\n\n");

	/* Event monitoring loop */
	while (1) {
		pfd.revents = 0;
		ret = poll(&pfd, 1, -1);

		if (ret < 0) {
			if (errno == EINTR)
				continue;
			fprintf(stderr, "Error: poll failed: %s\n", strerror(errno));
			ret = EXIT_FAILURE;
			break;
		}

		if (!(pfd.revents & POLLIN))
			continue;

		/* Get the async event */
		if (ibv_get_async_event(ctx, &event)) {
			fprintf(stderr, "Error: Failed to get async event: %s\n",
				strerror(errno));
			continue;
		}

		/* Handle the event */
		switch (event.event_type) {
		case IBV_EVENT_DEVICE_SPEED_CHANGE:
			printf(">>> Speed change event received <<<\n");
			query_port_speed(ctx, port_num);
			printf("\n");
			break;

		case IBV_EVENT_PORT_ACTIVE:
			printf(">>> Port %d is now active <<<\n", event.element.port_num);
			query_port_speed(ctx, port_num);
			printf("\n");
			break;

		case IBV_EVENT_PORT_ERR:
			printf(">>> Port %d error (link down) <<<\n", event.element.port_num);
			break;

		default:
			printf(">>> Other event received (type=%d) <<<\n", event.event_type);
			break;
		}

		/* Acknowledge the event */
		ibv_ack_async_event(&event);
	}

	ret = EXIT_SUCCESS;

close_device:
	ibv_close_device(ctx);
free_dev_list:
	ibv_free_device_list(dev_list);

	return ret;
}
